# Docker Compose configuration for KG Explorer ETL pipeline local development
# Provides Neo4j graph database for testing the knowledge graph ingestion pipeline.
#
# Usage:
#   docker compose up -d        # Start services
#   docker compose down         # Stop services
#   docker compose logs -f      # View logs
#   docker compose down -v      # Stop and remove volumes

version: '3.8'

services:
  # ==========================================================================
  # Neo4j Graph Database
  # ==========================================================================
  neo4j:
    image: neo4j:5.15-community
    container_name: kg-explorer-neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"   # HTTP browser interface
      - "7687:7687"   # Bolt protocol for drivers
    environment:
      NEO4J_AUTH: neo4j/password123  # Change in production
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
      NEO4J_dbms_memory_heap_initial__size: 512m
      NEO4J_dbms_memory_heap_max__size: 1G
      NEO4J_dbms_memory_pagecache_size: 512m
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7474"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - kg-network

  # ==========================================================================
  # Redis (for caching and rate limiting)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: kg-explorer-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - kg-network

  # ==========================================================================
  # MinIO (S3-compatible object storage for large data)
  # ==========================================================================
  minio:
    image: minio/minio:latest
    container_name: kg-explorer-minio
    restart: unless-stopped
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123  # Change in production
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - kg-network

  # ==========================================================================
  # TypeDB (optional - for advanced reasoning)
  # ==========================================================================
  typedb:
    image: vaticle/typedb:2.25.0
    container_name: kg-explorer-typedb
    restart: unless-stopped
    ports:
      - "1729:1729"
    volumes:
      - typedb_data:/opt/typedb-all-linux/server/data
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/1729"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - kg-network
    profiles:
      - full  # Only start with: docker compose --profile full up

  # ==========================================================================
  # Grafana (metrics visualization)
  # ==========================================================================
  grafana:
    image: grafana/grafana:10.2.0
    container_name: kg-explorer-grafana
    restart: unless-stopped
    ports:
      - "3001:3000"  # Using 3001 to avoid conflict with Next.js dev server
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin123  # Change in production
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./docker/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    networks:
      - kg-network
    profiles:
      - monitoring

  # ==========================================================================
  # Prometheus (metrics collection)
  # ==========================================================================
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: kg-explorer-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - prometheus_data:/prometheus
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
    networks:
      - kg-network
    profiles:
      - monitoring

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  neo4j_plugins:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  typedb_data:
    driver: local
  grafana_data:
    driver: local
  prometheus_data:
    driver: local

# ==========================================================================
# Networks
# ==========================================================================
networks:
  kg-network:
    driver: bridge
